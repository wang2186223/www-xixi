# 🚀 数据统计系统部署说明

## 📋 已完成的配置

### ✅ 1. Google Sheets 表格配置
- **主表格ID**: `1vbBuPqQE8ho6XJgZR4fxDskEfEbQn1CnD4I_K41FNyU`
- **表格URL**: [https://docs.google.com/spreadsheets/d/1vbBuPqQE8ho6XJgZR4fxDskEfEbQn1CnD4I_K41FNyU/](https://docs.google.com/spreadsheets/d/1vbBuPqQE8ho6XJgZR4fxDskEfEbQn1CnD4I_K41FNyU/)
- **每日表格命名**: `xixi-YYYY-MM-DD`（例如：`xixi-2025-01-15`）

### ✅ 2. Google Apps Script 部署
- **部署URL**: `https://script.google.com/macros/s/AKfycbzYA0Fe1-_ihK8E44GHmTrVQBYgjKkNM39sdGpl0DrdhOWxTaaaowf3eEvLXxbq08i1ug/exec`
- **脚本文件**: `analytics-script.js`

### ✅ 3. 前端模板配置
已在以下模板文件中添加数据上报代码：

#### 📄 chapter.html
- ✅ 页面访问上报（page_visit）
- ✅ 广告点击监控（ad_click）
- 位置：`tools/templates/chapter.html`

#### 📄 home.html
- ✅ 页面访问上报（page_visit）
- 位置：`tools/templates/home.html`

#### 📄 novel.html
- ✅ 页面访问上报（page_visit）
- 位置：`tools/templates/novel.html`

---

## 🔧 Google Apps Script 部署步骤

### 步骤 1: 复制脚本代码
打开 `analytics-script.js` 文件，复制所有代码。

### 步骤 2: 创建 Apps Script 项目
1. 打开 Google Sheets 主表格：[https://docs.google.com/spreadsheets/d/1vbBuPqQE8ho6XJgZR4fxDskEfEbQn1CnD4I_K41FNyU/](https://docs.google.com/spreadsheets/d/1vbBuPqQE8ho6XJgZR4fxDskEfEbQn1CnD4I_K41FNyU/)
2. 点击菜单：**扩展程序** > **Apps Script**
3. 删除默认的 `myFunction()` 代码
4. 粘贴 `analytics-script.js` 的内容
5. 保存（Ctrl+S 或 Cmd+S）

### 步骤 3: 部署为 Web 应用
1. 点击右上角 **部署** 按钮 > **新建部署**
2. 选择类型：**网页应用**
3. 配置：
   - **描述**: `网站访问统计API v1.0`
   - **执行身份**: 我
   - **访问权限**: 任何人
4. 点击 **部署**
5. 复制生成的 **网页应用网址**（应该是上面提到的URL）

### 步骤 4: 验证部署
在浏览器中访问部署URL（GET请求）：
```
https://script.google.com/macros/s/AKfycbzYA0Fe1-_ihK8E44GHmTrVQBYgjKkNM39sdGpl0DrdhOWxTaaaowf3eEvLXxbq08i1ug/exec
```

应该看到：`Analytics endpoint is working! (Daily Spreadsheets Version)`

---

## 🧪 测试数据上报

### 方法1: 使用 Apps Script 测试函数

在 Apps Script 编辑器中运行：

```javascript
// 测试页面访问
testPageVisit()

// 测试广告点击
testAdClick()

// 手动更新控制台
manualUpdateDashboard()
```

### 方法2: 使用 curl 测试

#### 测试页面访问：
```bash
curl -X POST \
  'https://script.google.com/macros/s/AKfycbzYA0Fe1-_ihK8E44GHmTrVQBYgjKkNM39sdGpl0DrdhOWxTaaaowf3eEvLXxbq08i1ug/exec' \
  -H 'Content-Type: application/json' \
  -d '{
    "page": "https://www.xixi.com/test",
    "userAgent": "Mozilla/5.0 (Test)",
    "userIP": "127.0.0.1"
  }'
```

#### 测试广告点击：
```bash
curl -X POST \
  'https://script.google.com/macros/s/AKfycbzYA0Fe1-_ihK8E44GHmTrVQBYgjKkNM39sdGpl0DrdhOWxTaaaowf3eEvLXxbq08i1ug/exec' \
  -H 'Content-Type: application/json' \
  -d '{
    "eventType": "ad_click",
    "novel": "Test Novel",
    "chapter": "1",
    "pageUrl": "https://www.xixi.com/novels/test/chapter-1",
    "adSlot": "test-ad-slot",
    "adPosition": "500",
    "scrollDepth": "300",
    "userIP": "127.0.0.1",
    "userAgent": "Mozilla/5.0 (Test)",
    "screenSize": "1920x1080",
    "stayDuration": 30,
    "totalClickCount": 1,
    "clickSource": "return_50s"
  }'
```

### 方法3: 浏览器控制台测试

访问任意网站页面，打开浏览器开发者工具（F12），在控制台运行：

```javascript
// 测试页面访问上报
sendPageVisit();

// 查看广告点击监控状态
console.log('[AdClick] 监控已启动');
```

---

## 📊 查看统计数据

### 主控制台
打开主表格，查看 **📊总控制台** 工作表：
[https://docs.google.com/spreadsheets/d/1vbBuPqQE8ho6XJgZR4fxDskEfEbQn1CnD4I_K41FNyU/](https://docs.google.com/spreadsheets/d/1vbBuPqQE8ho6XJgZR4fxDskEfEbQn1CnD4I_K41FNyU/)

显示内容：
- 今日访问量
- 总访问量
- 总广告点击
- 活跃天数
- 平均日访问

### 每日详细数据
1. 打开主表格的 **📑表格索引** 工作表
2. 找到对应日期的表格链接
3. 点击链接查看当天详细数据

每日表格包含：
- **📊当日统计**: 当天概览
- **页面访问**: 每次访问的详细记录
- **广告点击**: 广告点击的详细信息

---

## 🔍 数据上报流程

### 1. 页面访问上报
```
用户访问页面
    ↓
页面加载完成（DOMContentLoaded）
    ↓
自动获取用户IP（3个API备用）
    ↓
上报数据到 Google Apps Script
    ↓
写入每日表格 "页面访问" 工作表
    ↓
5% 概率更新 "当日统计"
```

### 2. 广告点击上报
```
页面加载
    ↓
检测广告存在（AdSense: .adsbygoogle）
    ↓
监听页面可见性变化（visibilitychange）
    ↓
用户离开页面（记录时间）
    ↓
用户返回页面（计算离开时长）
    ↓
离开时长 ≤ 50秒？
    ↓ 是
上报广告点击数据
    ↓
写入每日表格 "广告点击" 工作表
```

---

## 📝 配置文件说明

### analytics-script.js
**关键配置**：
```javascript
const MAIN_SPREADSHEET_ID = '1vbBuPqQE8ho6XJgZR4fxDskEfEbQn1CnD4I_K41FNyU';
const DATA_FOLDER_NAME = '网站统计数据';
const SPREADSHEET_PREFIX = 'xixi-';
```

### 前端模板
**上报API地址**（所有模板统一）：
```javascript
const API_URL = 'https://script.google.com/macros/s/AKfycbzYA0Fe1-_ihK8E44GHmTrVQBYgjKkNM39sdGpl0DrdhOWxTaaaowf3eEvLXxbq08i1ug/exec';
```

---

## ⚙️ 性能优化配置

### 概率性更新
为减少 Google Sheets API 写入压力：

- **当日统计更新**: 5% 概率（平均每20次请求）
- **主控制台更新**: 1% 概率（平均每100次请求）
- **索引清理**: 0.5% 概率（平均每200次请求）

### 并发控制
使用 `LockService.getScriptLock()` 防止并发创建重复表格：
- 等待时间：最多10秒
- 保护范围：表格创建全过程

---

## 🛠️ 维护命令

### 手动清理重复索引
在 Apps Script 编辑器中运行：
```javascript
manualCleanupDuplicates()
```

### 手动更新控制台
```javascript
manualUpdateDashboard()
```

### 测试表格创建
```javascript
testCreateDailySpreadsheet()
```

---

## ⚠️ 注意事项

1. **部署后更新代码**：如果修改了 `analytics-script.js`，需要重新部署：
   - 点击 **部署** > **管理部署**
   - 点击现有部署的 **编辑** 图标
   - 修改版本号
   - 点击 **部署**

2. **CORS 限制**：前端使用 `mode: 'no-cors'`，无法读取响应内容

3. **IP获取可能失败**：有3层备用API，失败时标记为 `Unknown`

4. **表格数量限制**：每天创建一个新表格，建议定期归档旧表格

5. **广告检测**：目前只支持 Google AdSense（`.adsbygoogle` 类名）

---

## 📖 相关文档

- **完整架构说明**: `数据上报系统完整架构.md`
- **脚本代码**: `analytics-script.js`
- **模板文件**: 
  - `tools/templates/chapter.html`
  - `tools/templates/home.html`
  - `tools/templates/novel.html`

---

**部署完成时间**: 2025-01-15  
**维护者**: 系统管理员
