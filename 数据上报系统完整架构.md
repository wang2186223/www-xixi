# ğŸ“Š ç½‘ç«™è®¿é—®ç»Ÿè®¡ç³»ç»Ÿ - å®Œæ•´ä¸ŠæŠ¥é€»è¾‘æ¢³ç†

> **ç³»ç»Ÿæ¶æ„**ï¼šå‰ç«¯æ•°æ®é‡‡é›† â†’ Google Apps Script API â†’ Google Sheets å­˜å‚¨
> **éƒ¨ç½²URL**ï¼š`https://script.google.com/macros/s/AKfycbzYA0Fe1-_ihK8E44GHmTrVQBYgjKkNM39sdGpl0DrdhOWxTaaaowf3eEvLXxbq08i1ug/exec`
> **ä¸»è¡¨æ ¼ID**ï¼š`1vbBuPqQE8ho6XJgZR4fxDskEfEbQn1CnD4I_K41FNyU`
> **è¡¨æ ¼URL**ï¼š[https://docs.google.com/spreadsheets/d/1vbBuPqQE8ho6XJgZR4fxDskEfEbQn1CnD4I_K41FNyU/](https://docs.google.com/spreadsheets/d/1vbBuPqQE8ho6XJgZR4fxDskEfEbQn1CnD4I_K41FNyU/)

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ¦‚è¿°

### æ•°æ®æµå‘
```
å‰ç«¯é¡µé¢(chapter.html) 
    â†“ è§¦å‘äº‹ä»¶
å‰ç«¯JavaScripté‡‡é›†æ•°æ® 
    â†“ fetch POST
Google Apps Script (analytics-script.js)
    â†“ å¤„ç†åˆ†å‘
Google Sheetså­˜å‚¨
    â”œâ”€â”€ ä¸»æ§åˆ¶å°è¡¨æ ¼ï¼ˆæ€»è§ˆï¼‰
    â””â”€â”€ æ¯æ—¥ç‹¬ç«‹è¡¨æ ¼ï¼ˆè¯¦ç»†æ•°æ®ï¼‰
```

### è¡¨æ ¼ç»“æ„
```
ä¸»æ§åˆ¶å°è¡¨æ ¼ (1vbBuPqQE8ho6XJgZR4fxDskEfEbQn1CnD4I_K41FNyU)
â”œâ”€â”€ ğŸ“Šæ€»æ§åˆ¶å° (Sheet 0) - å…¨å±€ç»Ÿè®¡æ±‡æ€»
â””â”€â”€ ğŸ“‘è¡¨æ ¼ç´¢å¼• (Sheet 1) - æ¯æ—¥è¡¨æ ¼ç´¢å¼•

æ¯æ—¥è¡¨æ ¼ (xixi-YYYY-MM-DD)
â”œâ”€â”€ ğŸ“Šå½“æ—¥ç»Ÿè®¡ - å½“å¤©ç»Ÿè®¡æ¦‚è§ˆ
â”œâ”€â”€ é¡µé¢è®¿é—® - é¡µé¢æµè§ˆè®°å½•
â”œâ”€â”€ å¹¿å‘Šå¼•å¯¼ - å¹¿å‘Šå¼•å¯¼å¼¹çª—è®°å½•ï¼ˆæš‚æœªä½¿ç”¨ï¼‰
â””â”€â”€ å¹¿å‘Šç‚¹å‡» - å¹¿å‘Šç‚¹å‡»è®°å½•
```

---

## ğŸ“ ä¸‰å¤§æ ¸å¿ƒä¸ŠæŠ¥äº‹ä»¶

### 1ï¸âƒ£ é¡µé¢è®¿é—®ä¸ŠæŠ¥ (page_visit)

#### è§¦å‘æ—¶æœº
- **ç«‹å³è§¦å‘**ï¼šé¡µé¢åŠ è½½å®Œæˆæ—¶è‡ªåŠ¨è§¦å‘ï¼ˆDOMContentLoaded æˆ–é¡µé¢å·²åŠ è½½ï¼‰
- **è§¦å‘é¢‘ç‡**ï¼šæ¯æ¬¡è®¿é—®é¡µé¢è§¦å‘ä¸€æ¬¡

#### å‰ç«¯ä»£ç ä½ç½®
**æ–‡ä»¶**ï¼š`tools/templates/chapter.html` (è¡Œ 775-850)

```javascript
// ğŸ“ ä»£ç ä½ç½®ï¼šline 775-850
function sendPageVisit() {
    // å…ˆè·å–ç”¨æˆ·IPåœ°å€
    getUserIP().then(userIP => {
        const data = {
            page: window.location.href,        // å½“å‰é¡µé¢URL
            userAgent: navigator.userAgent,     // ç”¨æˆ·æµè§ˆå™¨ä¿¡æ¯
            userIP: userIP                      // ç”¨æˆ·IPåœ°å€
        };
        
        // å‘é€åˆ°Google Apps Script
        fetch('https://script.google.com/macros/s/.../exec', {
            method: 'POST',
            mode: 'no-cors',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
    }).catch(error => {
        // IPè·å–å¤±è´¥æ—¶ä»å‘é€æ•°æ®ï¼ˆIPæ ‡è®°ä¸ºUnknownï¼‰
        // ... åŒæ ·çš„é€»è¾‘
    });
}

// é¡µé¢åŠ è½½åè‡ªåŠ¨è°ƒç”¨
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', sendPageVisit);
} else {
    sendPageVisit();
}
```

#### ä¸ŠæŠ¥æ•°æ®ç»“æ„
```json
{
    "page": "https://novel.goodluckark.com/novels/test/chapter-1",
    "userAgent": "Mozilla/5.0 (iPhone; CPU iPhone OS 14_0...)",
    "userIP": "192.168.1.1"
}
```

#### åç«¯å¤„ç†
**æ–‡ä»¶**ï¼š`analytics-script.js` (handlePageVisitEvent å‡½æ•°)

```javascript
function handlePageVisitEvent(dailySpreadsheet, data) {
    const visitSheet = dailySpreadsheet.getSheetByName('é¡µé¢è®¿é—®');
    
    const rowData = [
        getTimeString(),              // æ—¶é—´
        data.page || '',              // è®¿é—®é¡µé¢
        data.userAgent || '',         // ç”¨æˆ·å±æ€§
        data.userIP || 'Unknown'      // IPåœ°å€
    ];
    
    visitSheet.appendRow(rowData);
    
    // 5%æ¦‚ç‡æ›´æ–°å½“æ—¥ç»Ÿè®¡
    if (Math.random() < 0.05) {
        updateDailySummary(dailySpreadsheet);
    }
}
```

#### å­˜å‚¨ä½ç½®
- **è¡¨æ ¼**ï¼š`adx-good-YYYY-MM-DD`
- **å·¥ä½œè¡¨**ï¼š`é¡µé¢è®¿é—®`
- **å­—æ®µ**ï¼š`[æ—¶é—´, è®¿é—®é¡µé¢, ç”¨æˆ·å±æ€§, IPåœ°å€]`

---

### 2ï¸âƒ£ å¹¿å‘Šå¼•å¯¼ä¸ŠæŠ¥ (ad_guide_triggered)

#### è§¦å‘æ—¶æœº
- **æ¡ä»¶è§¦å‘**ï¼šå½“å¹¿å‘Šå¼•å¯¼ç³»ç»Ÿï¼ˆAd Click Guide Systemï¼‰å†³å®šæ˜¾ç¤ºå¼•å¯¼å¼¹çª—æ—¶
- **è§¦å‘è§„åˆ™**ï¼š
  - ç”¨æˆ·ç´¯è®¡çœ‹åˆ° >= 5 ä¸ªå¹¿å‘Š
  - å½“å‰é¡µé¢æœ‰å¹¿å‘Š
  - æœªè¾¾åˆ°è§¦å‘æ¬¡æ•°ä¸Šé™ï¼ˆ3æ¬¡/24å°æ—¶ï¼‰
  - æœªåœ¨é•¿æ—¶é—´å†·å´æœŸï¼ˆ72å°æ—¶ï¼‰

#### å‰ç«¯ä»£ç ä½ç½®
**æ–‡ä»¶**ï¼š`tools/templates/chapter.html` (è¡Œ 2272-2336)

```javascript
// ğŸ“ ä»£ç ä½ç½®ï¼šline 2272-2336 (åœ¨ AdClickGuideSystem ç±»ä¸­)
reportAdGuideTriggered() {
    const triggerCount = this.getTriggerCount();
    const isInLongCooldown = this.isInLongCooldown();
    
    getUserIP().then(userIP => {
        const data = {
            eventType: 'ad_guide_triggered',
            page: window.location.href,
            userAgent: navigator.userAgent,
            userIP: userIP,
            totalAdsSeen: this.totalAdsSeen,                           // ç´¯è®¡çœ‹åˆ°çš„å¹¿å‘Šæ•°
            currentPageAds: this.currentPageAds.length,                // å½“å‰é¡µé¢å¹¿å‘Šæ•°
            triggerCount: triggerCount,                                // å·²è§¦å‘æ¬¡æ•°
            maxTriggersBeforeLongCooldown: this.MAX_TRIGGERS_BEFORE_LONG_COOLDOWN,  // æœ€å¤§è§¦å‘æ¬¡æ•°(3)
            longCooldownHours: this.LONG_COOLDOWN_HOURS,               // é•¿å†·å´æ—¶é—´(72å°æ—¶)
            isInLongCooldown: isInLongCooldown,                        // æ˜¯å¦åœ¨å†·å´æœŸ
            timestamp: new Date().toISOString()
        };
        
        fetch('https://script.google.com/macros/s/.../exec', {
            method: 'POST',
            mode: 'no-cors',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
    }).catch(error => {
        // IPè·å–å¤±è´¥æ—¶çš„å¤‡ç”¨é€»è¾‘ï¼ˆåŒä¸Šï¼‰
    });
}
```

#### ä¸ŠæŠ¥æ•°æ®ç»“æ„
```json
{
    "eventType": "ad_guide_triggered",
    "page": "https://novel.goodluckark.com/novels/test/chapter-1",
    "userAgent": "Mozilla/5.0...",
    "userIP": "192.168.1.1",
    "totalAdsSeen": 15,                     // æ€»å…±çœ‹åˆ°15ä¸ªå¹¿å‘Š
    "currentPageAds": 3,                    // å½“å‰é¡µé¢3ä¸ªå¹¿å‘Š
    "triggerCount": 2,                      // å·²è§¦å‘2æ¬¡
    "maxTriggersBeforeLongCooldown": 3,     // æœ€å¤§3æ¬¡
    "longCooldownHours": 72,                // å†·å´72å°æ—¶
    "isInLongCooldown": false,              // æœªåœ¨å†·å´æœŸ
    "timestamp": "2025-01-15T10:30:45.123Z"
}
```

#### åç«¯å¤„ç†
**æ–‡ä»¶**ï¼š`analytics-script.js` (handleAdGuideEvent å‡½æ•°)

```javascript
function handleAdGuideEvent(dailySpreadsheet, data) {
    const adGuideSheet = dailySpreadsheet.getSheetByName('å¹¿å‘Šå¼•å¯¼');
    
    const rowData = [
        getTimeString(),
        data.page || '',
        data.userAgent || '',
        data.userIP || 'Unknown',
        data.totalAdsSeen || 0,
        data.currentPageAds || 0,
        data.triggerCount || 0,
        data.maxTriggers || 3,
        data.timestamp || ''
    ];
    
    adGuideSheet.appendRow(rowData);
}
```

#### å­˜å‚¨ä½ç½®
- **è¡¨æ ¼**ï¼š`adx-good-YYYY-MM-DD`
- **å·¥ä½œè¡¨**ï¼š`å¹¿å‘Šå¼•å¯¼`
- **å­—æ®µ**ï¼š`[æ—¶é—´, è®¿é—®é¡µé¢, ç”¨æˆ·å±æ€§, IPåœ°å€, ç´¯è®¡å¹¿å‘Šæ•°, å½“å‰é¡µå¹¿å‘Šæ•°, è§¦å‘æ¬¡æ•°, æœ€å¤§è§¦å‘æ¬¡æ•°, äº‹ä»¶æ—¶é—´æˆ³]`

#### é™„åŠ è¡Œä¸º
- åŒæ—¶è§¦å‘ Facebook Pixel äº‹ä»¶ï¼š`1_c`ï¼ˆå¹¿å‘Šå¼•å¯¼å¼¹çª—è§¦å‘ï¼‰

---

### 3ï¸âƒ£ å¹¿å‘Šç‚¹å‡»ä¸ŠæŠ¥ (ad_click)

#### è§¦å‘æ—¶æœº
- **è¿”å›æ£€æµ‹è§¦å‘**ï¼šç”¨æˆ·ç¦»å¼€é¡µé¢ååœ¨ 50 ç§’å†…è¿”å›ï¼ˆæ¨æµ‹ä¸ºå¹¿å‘Šç‚¹å‡»ï¼‰
- **æ£€æµ‹é€»è¾‘**ï¼š
  1. é¡µé¢åŠ è½½æ—¶å¯åŠ¨ç›‘æ§
  2. æ£€æµ‹åˆ°é¡µé¢æœ‰å¹¿å‘Šï¼ˆGPTå¹¿å‘Šï¼‰
  3. ç›‘å¬ `visibilitychange` äº‹ä»¶
  4. ç”¨æˆ·ç¦»å¼€æ—¶è®°å½•æ—¶é—´
  5. ç”¨æˆ·è¿”å›æ—¶æ£€æŸ¥ç¦»å¼€æ—¶é•¿ â‰¤ 50ç§’
  6. ç¬¦åˆæ¡ä»¶åˆ™ä¸ŠæŠ¥å¹¿å‘Šç‚¹å‡»

#### å‰ç«¯ä»£ç ä½ç½®
**æ–‡ä»¶**ï¼š`tools/templates/chapter.html` (è¡Œ 854-985)

```javascript
// ğŸ“ ä»£ç ä½ç½®ï¼šline 854-985
(function() {
    'use strict';
    
    const CONFIG = {
        scriptUrl: 'https://script.google.com/macros/s/.../exec',
        returnWindow: 50000,  // 50ç§’è¿”å›çª—å£
        storageKey: 'ad_total_clicks',
        debugMode: true
    };
    
    let pageLoadTime = Date.now();
    let leaveTime = null;
    let hasAds = false;
    
    // æ£€æŸ¥å¹¿å‘Šæ˜¯å¦å­˜åœ¨
    function checkAds() {
        const checkInterval = setInterval(() => {
            const gptAds = document.querySelectorAll('[id^="div-gpt-ad-"]');
            if (gptAds.length > 0) {
                hasAds = true;
                clearInterval(checkInterval);
            }
        }, 500);
        setTimeout(() => clearInterval(checkInterval), 10000);
    }
    
    // é¡µé¢éšè—æ—¶è®°å½•ç¦»å¼€æ—¶é—´
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            leaveTime = Date.now();
        } else {
            // é¡µé¢å¯è§æ—¶æ£€æŸ¥æ˜¯å¦åº”è¯¥ä¸ŠæŠ¥
            if (leaveTime && hasAds) {
                const awayDuration = Date.now() - leaveTime;
                if (awayDuration <= CONFIG.returnWindow) {
                    reportClick();  // âœ… è§¦å‘ä¸ŠæŠ¥
                }
                leaveTime = null;
            }
        }
    });
    
    // ä¸ŠæŠ¥å¹¿å‘Šç‚¹å‡»
    function reportClick() {
        const totalClicks = incrementClicks();
        const stayDuration = Math.round((Date.now() - pageLoadTime) / 1000);
        
        // è·å–GPTå¹¿å‘Šä¿¡æ¯
        const firstAd = document.querySelector('[id^="div-gpt-ad-"]');
        const adSlot = firstAd ? firstAd.id : 'unknown';
        const adPosition = firstAd ? Math.round(firstAd.getBoundingClientRect().top + window.scrollY) : 0;
        
        const data = {
            timestamp: new Date().toISOString(),
            eventType: 'ad_click',
            novel: '{{ novel.title }}',           // Jinja2æ¨¡æ¿å˜é‡
            chapter: '{{ chapter.number }}',      // Jinja2æ¨¡æ¿å˜é‡
            pageUrl: window.location.href,
            adSlot: adSlot,                       // å¹¿å‘Šä½ID
            adPosition: adPosition,               // å¹¿å‘Šä½ç½®(px)
            scrollDepth: Math.round(window.scrollY),  // æ»šåŠ¨æ·±åº¦
            userIP: '',                           // åç»­è·å–
            userAgent: navigator.userAgent,
            screenSize: `${window.screen.width}x${window.screen.height}`,
            stayDuration: stayDuration,           // åœç•™æ—¶é•¿(ç§’)
            totalClickCount: totalClicks,         // å†å²ç´¯è®¡ç‚¹å‡»
            clickSource: 'return_50s'             // ç‚¹å‡»æ¥æº
        };
        
        sendData(data);
    }
    
    // ç´¯è®¡ç‚¹å‡»æ¬¡æ•°ï¼ˆlocalStorageï¼‰
    function incrementClicks() {
        let total = parseInt(localStorage.getItem(CONFIG.storageKey) || '0');
        total++;
        localStorage.setItem(CONFIG.storageKey, total.toString());
        return total;
    }
    
    // åˆå§‹åŒ–
    checkAds();
})();
```

#### ä¸ŠæŠ¥æ•°æ®ç»“æ„
```json
{
    "timestamp": "2025-01-15T10:35:22.456Z",
    "eventType": "ad_click",
    "novel": "My Rejected Mate Regrets",
    "chapter": "15",
    "pageUrl": "https://novel.goodluckark.com/novels/my-rejected-mate-regrets/chapter-15",
    "adSlot": "div-gpt-ad-1762511964282-0",  // å¹¿å‘Šä½ID
    "adPosition": 850,                       // å¹¿å‘Šåœ¨é¡µé¢ä¸­çš„ä½ç½®(åƒç´ )
    "scrollDepth": 500,                      // ç”¨æˆ·æ»šåŠ¨æ·±åº¦
    "userIP": "192.168.1.1",
    "userAgent": "Mozilla/5.0 (iPhone...)",
    "screenSize": "390x844",                 // å±å¹•å°ºå¯¸
    "stayDuration": 45,                      // åœç•™æ—¶é•¿45ç§’
    "totalClickCount": 5,                    // å†å²ç¬¬5æ¬¡ç‚¹å‡»
    "clickSource": "return_50s"              // æ¥æºï¼š50ç§’è¿”å›æ£€æµ‹
}
```

#### åç«¯å¤„ç†
**æ–‡ä»¶**ï¼š`analytics-script.js` (handleAdClickEvent å‡½æ•°)

```javascript
function handleAdClickEvent(dailySpreadsheet, data) {
    let adClickSheet = dailySpreadsheet.getSheetByName('å¹¿å‘Šç‚¹å‡»');
    
    // å¦‚æœå·¥ä½œè¡¨ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨åˆ›å»º
    if (!adClickSheet) {
        adClickSheet = addAdClickSheetToExisting(dailySpreadsheet);
    }
    
    const deviceType = getDeviceType(data.userAgent);
    
    const rowData = [
        getTimeString(),                    // æ—¶é—´
        data.novel || '',                   // å°è¯´æ ‡é¢˜
        data.chapter || '',                 // ç« èŠ‚å·
        data.pageUrl || '',                 // é¡µé¢URL
        data.adSlot || '',                  // å¹¿å‘Šä½ID
        data.adPosition || '',              // å¹¿å‘Šä½ç½®(px)
        data.scrollDepth || '',             // æ»šåŠ¨æ·±åº¦
        data.userIP || 'Unknown',           // IPåœ°å€
        deviceType,                         // è®¾å¤‡ç±»å‹
        data.screenSize || '',              // å±å¹•å°ºå¯¸
        data.stayDuration || 0,             // åœç•™æ—¶é•¿(ç§’)
        data.totalClickCount || 0,          // å†å²ç´¯è®¡ç‚¹å‡»
        data.clickSource || 'normal'        // ç‚¹å‡»æ¥æº
    ];
    
    adClickSheet.appendRow(rowData);
    
    // 5%æ¦‚ç‡æ›´æ–°å½“æ—¥ç»Ÿè®¡
    if (Math.random() < 0.05) {
        updateDailySummary(dailySpreadsheet);
    }
}
```

#### å­˜å‚¨ä½ç½®
- **è¡¨æ ¼**ï¼š`adx-good-YYYY-MM-DD`
- **å·¥ä½œè¡¨**ï¼š`å¹¿å‘Šç‚¹å‡»`
- **å­—æ®µ**ï¼š`[æ—¶é—´, å°è¯´æ ‡é¢˜, ç« èŠ‚å·, é¡µé¢URL, å¹¿å‘Šä½ID, å¹¿å‘Šä½ç½®(px), æ»šåŠ¨æ·±åº¦, ç”¨æˆ·IP, è®¾å¤‡ç±»å‹, å±å¹•å°ºå¯¸, åœç•™æ—¶é•¿(ç§’), å†å²ç´¯è®¡ç‚¹å‡», ç‚¹å‡»æ¥æº]`

#### é™„åŠ è¡Œä¸º
- åŒæ—¶è§¦å‘ Google Analytics äº‹ä»¶ï¼š`ad_click`
- æœ¬åœ°å­˜å‚¨ç´¯è®¡ç‚¹å‡»æ¬¡æ•°ï¼ˆlocalStorage: `ad_total_clicks`ï¼‰

---

## ğŸ”§ åç«¯å¤„ç†æµç¨‹

### Google Apps Script å…¥å£å‡½æ•°

```javascript
function doPost(e) {
    // 1. è§£æè¯·æ±‚æ•°æ®
    const data = JSON.parse(e.postData.contents);
    const eventType = data.eventType || 'page_visit';
    
    // 2. è·å–æˆ–åˆ›å»ºä»Šæ—¥è¡¨æ ¼ï¼ˆå¸¦å¹¶å‘é”ä¿æŠ¤ï¼‰
    const dateString = getDateString();  // æ ¼å¼ï¼š2025-01-15
    const dailySpreadsheet = getOrCreateDailySpreadsheet(dateString);
    
    // 3. æ ¹æ®äº‹ä»¶ç±»å‹åˆ†å‘å¤„ç†
    if (eventType === 'ad_guide_triggered') {
        handleAdGuideEvent(dailySpreadsheet, data);
    } else if (eventType === 'ad_click') {
        handleAdClickEvent(dailySpreadsheet, data);
    } else {
        handlePageVisitEvent(dailySpreadsheet, data);  // é»˜è®¤ä¸ºpage_visit
    }
    
    // 4. æ¦‚ç‡æ€§æ›´æ–°ç»Ÿè®¡ï¼ˆå‡å°‘å†™å…¥å‹åŠ›ï¼‰
    if (Math.random() < 0.01) {
        updateMainDashboard();  // 1%æ¦‚ç‡æ›´æ–°ä¸»æ§åˆ¶å°
    }
    
    // 5. æ¦‚ç‡æ€§æ¸…ç†é‡å¤ç´¢å¼•
    if (Math.random() < 0.005) {
        cleanupDuplicateIndexRecords();  // 0.5%æ¦‚ç‡æ¸…ç†
    }
    
    return ContentService.createTextOutput(JSON.stringify({status: 'success'}));
}
```

### æ¯æ—¥è¡¨æ ¼ç®¡ç†æœºåˆ¶

#### è¡¨æ ¼åˆ›å»ºç­–ç•¥
```javascript
function getOrCreateDailySpreadsheet(dateString) {
    // 1. å¿«é€ŸæŸ¥æ‰¾ç´¢å¼•ï¼ˆæ— é”ï¼‰
    const spreadsheetId = findSpreadsheetIdFromIndex(indexSheet, dateString);
    if (spreadsheetId) {
        return SpreadsheetApp.openById(spreadsheetId);
    }
    
    // 2. è·å–é”ï¼Œé˜²æ­¢å¹¶å‘åˆ›å»ºï¼ˆæœ€å¤šç­‰å¾…10ç§’ï¼‰
    const lock = LockService.getScriptLock();
    lock.waitLock(10000);
    
    // 3. å†æ¬¡æ£€æŸ¥ç´¢å¼•ï¼ˆå¯èƒ½å…¶ä»–çº¿ç¨‹å·²åˆ›å»ºï¼‰
    spreadsheetId = findSpreadsheetIdFromIndex(indexSheet, dateString);
    if (spreadsheetId) {
        lock.releaseLock();
        return SpreadsheetApp.openById(spreadsheetId);
    }
    
    // 4. æœç´¢æ–‡ä»¶å¤¹ä¸­æ˜¯å¦å­˜åœ¨åŒåè¡¨æ ¼ï¼ˆå…³é”®é˜²é‡å¤ï¼‰
    const folder = getOrCreateDataFolder();
    const files = folder.getFilesByName(spreadsheetName);
    if (files.hasNext()) {
        const file = files.next();
        const spreadsheet = SpreadsheetApp.openById(file.getId());
        addToIndex(indexSheet, dateString, file.getId(), file.getUrl());
        lock.releaseLock();
        return spreadsheet;
    }
    
    // 5. åˆ›å»ºæ–°çš„æ¯æ—¥è¡¨æ ¼
    const newSpreadsheet = SpreadsheetApp.create(spreadsheetName);
    const newFile = DriveApp.getFileById(newSpreadsheet.getId());
    folder.addFile(newFile);
    DriveApp.getRootFolder().removeFile(newFile);
    
    // 6. åˆå§‹åŒ–è¡¨æ ¼ç»“æ„
    initializeDailySpreadsheet(newSpreadsheet, dateString);
    
    // 7. æ·»åŠ åˆ°ç´¢å¼•
    addToIndex(indexSheet, dateString, newSpreadsheet.getId(), newSpreadsheet.getUrl());
    
    lock.releaseLock();
    return newSpreadsheet;
}
```

#### è¡¨æ ¼åˆå§‹åŒ–
åˆ›å»º4ä¸ªå·¥ä½œè¡¨ï¼š
1. **ğŸ“Šå½“æ—¥ç»Ÿè®¡**ï¼ˆç´¢å¼•0ï¼‰ï¼šç»Ÿè®¡æ¦‚è§ˆ
2. **é¡µé¢è®¿é—®**ï¼šè®°å½•æ¯æ¬¡é¡µé¢æµè§ˆ
3. **å¹¿å‘Šå¼•å¯¼**ï¼šè®°å½•å¹¿å‘Šå¼•å¯¼å¼¹çª—
4. **å¹¿å‘Šç‚¹å‡»**ï¼šè®°å½•å¹¿å‘Šç‚¹å‡»è¡Œä¸º

### ç»Ÿè®¡æ›´æ–°æœºåˆ¶

#### æ¯æ—¥ç»Ÿè®¡æ›´æ–°
```javascript
function updateDailySummary(dailySpreadsheet) {
    const summarySheet = dailySpreadsheet.getSheetByName('ğŸ“Šå½“æ—¥ç»Ÿè®¡');
    
    // ç»Ÿè®¡å„é¡¹æ•°æ®
    const visitCount = visitSheet.getDataRange().getNumRows() - 1;      // é¡µé¢è®¿é—®æ•°
    const adGuideCount = adGuideSheet.getDataRange().getNumRows() - 1;  // å¹¿å‘Šå¼•å¯¼æ•°
    const adClickCount = adClickSheet.getDataRange().getNumRows() - 1;  // å¹¿å‘Šç‚¹å‡»æ•°
    
    // ç»Ÿè®¡ç‹¬ç«‹IP
    const ipData = visitSheet.getRange(2, 4, visitCount, 1).getValues();
    const uniqueIPs = new Set(ipData.flat().filter(ip => ip && ip !== 'Unknown')).size;
    
    // æ›´æ–°ç»Ÿè®¡è¡¨
    summarySheet.getRange(3, 2).setValue(visitCount);
    summarySheet.getRange(4, 2).setValue(adGuideCount);
    summarySheet.getRange(5, 2).setValue(adClickCount);
    summarySheet.getRange(6, 2).setValue(uniqueIPs);
    summarySheet.getRange(7, 2).setValue(getTimeString());
}
```

#### ä¸»æ§åˆ¶å°æ›´æ–°
```javascript
function updateMainDashboard() {
    // éå†æ‰€æœ‰æ¯æ—¥è¡¨æ ¼ï¼Œæ±‡æ€»ç»Ÿè®¡
    let totalVisits = 0;
    let totalAdGuides = 0;
    let activeDays = 0;
    let todayVisits = 0;
    
    // ç»Ÿè®¡æ‰€æœ‰è¡¨æ ¼æ•°æ®...
    
    // æ›´æ–°ä¸»æ§åˆ¶å°
    dashboardSheet.getRange(3, 2).setValue(todayVisits);
    dashboardSheet.getRange(4, 2).setValue(totalVisits);
    dashboardSheet.getRange(5, 2).setValue(totalAdGuides);
    dashboardSheet.getRange(6, 2).setValue(activeDays);
    dashboardSheet.getRange(7, 2).setValue(Math.round(totalVisits / activeDays));
}
```

---

## ğŸ› ï¸ è¾…åŠ©åŠŸèƒ½

### IPåœ°å€è·å–
**å‰ç«¯å®ç°**ï¼ˆ3å±‚å¤‡ç”¨æœºåˆ¶ï¼‰ï¼š
```javascript
async function getUserIP() {
    try {
        // æ–¹æ³•1: ipify.org
        const response = await fetch('https://api.ipify.org?format=json');
        const ipData = await response.json();
        return ipData.ip;
    } catch (error1) {
        try {
            // æ–¹æ³•2: httpbin.org
            const response = await fetch('https://httpbin.org/ip');
            const ipData = await response.json();
            return ipData.origin.split(',')[0].trim();
        } catch (error2) {
            try {
                // æ–¹æ³•3: jsonip.com
                const response = await fetch('https://jsonip.com');
                const ipData = await response.json();
                return ipData.ip;
            } catch (error3) {
                return 'Unknown';  // æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥
            }
        }
    }
}
```

### è®¾å¤‡ç±»å‹è¯†åˆ«
**åç«¯å®ç°**ï¼š
```javascript
function getDeviceType(userAgent) {
    if (!userAgent) return 'Unknown';
    
    if (/mobile/i.test(userAgent)) {
        if (/iphone/i.test(userAgent)) return 'iPhone';
        if (/android/i.test(userAgent)) return 'Android';
        return 'Mobile';
    }
    if (/tablet|ipad/i.test(userAgent)) return 'Tablet';
    return 'Desktop';
}
```

### ç´¢å¼•æ¸…ç†æœºåˆ¶
```javascript
function cleanupDuplicateIndexRecords() {
    // æŒ‰è¡¨æ ¼IDå»é‡ï¼Œæ¯ä¸ªè¡¨æ ¼IDåªä¿ç•™ç¬¬ä¸€æ¡
    const seen = new Map();
    const rowsToDelete = [];
    
    // æ£€æŸ¥é‡å¤...
    
    // ä»åå¾€å‰åˆ é™¤ï¼ˆé¿å…è¡Œå·å˜åŒ–ï¼‰
    rowsToDelete.reverse();
    for (const row of rowsToDelete) {
        indexSheet.deleteRow(row);
    }
}
```

---

## ğŸ“Š æ•°æ®ä¸ŠæŠ¥æ—¶åºå›¾

```
ç”¨æˆ·è®¿é—®é¡µé¢
    â†“
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ç«‹å³è§¦å‘ï¼šé¡µé¢è®¿é—®ä¸ŠæŠ¥ (page_visit)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    â†“
é¡µé¢åŠ è½½å®Œæˆ
    â†“
æ£€æµ‹å¹¿å‘Šå­˜åœ¨
    â†“
å¹¿å‘Šå¼•å¯¼ç³»ç»Ÿåˆå§‹åŒ–
    â†“
ç´¯è®¡çœ‹åˆ°5ä¸ªä»¥ä¸Šå¹¿å‘Šï¼Ÿ
    â†“ æ˜¯
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
æ¡ä»¶è§¦å‘ï¼šå¹¿å‘Šå¼•å¯¼ä¸ŠæŠ¥ (ad_guide_triggered)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    â†“
æ˜¾ç¤ºå¼•å¯¼å¼¹çª—
    â†“
ç”¨æˆ·ç‚¹å‡»å¹¿å‘Šç¦»å¼€é¡µé¢
    â†“
è®°å½•ç¦»å¼€æ—¶é—´
    â†“
50ç§’å†…è¿”å›ï¼Ÿ
    â†“ æ˜¯
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
æ£€æµ‹è§¦å‘ï¼šå¹¿å‘Šç‚¹å‡»ä¸ŠæŠ¥ (ad_click)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ”’ å¹¶å‘æ§åˆ¶ä¸æ€§èƒ½ä¼˜åŒ–

### å¹¶å‘é”æœºåˆ¶
- **åœºæ™¯**ï¼šé˜²æ­¢åŒä¸€å¤©åˆ›å»ºå¤šä¸ªè¡¨æ ¼
- **å®ç°**ï¼š`LockService.getScriptLock()`
- **ç­‰å¾…æ—¶é—´**ï¼šæœ€å¤š10ç§’
- **ä¿æŠ¤èŒƒå›´**ï¼šè¡¨æ ¼åˆ›å»ºå…¨è¿‡ç¨‹

### æ¦‚ç‡æ€§æ›´æ–°
- **å½“æ—¥ç»Ÿè®¡æ›´æ–°**ï¼š5% æ¦‚ç‡ï¼ˆå¹³å‡æ¯20æ¬¡è¯·æ±‚æ›´æ–°ä¸€æ¬¡ï¼‰
- **ä¸»æ§åˆ¶å°æ›´æ–°**ï¼š1% æ¦‚ç‡ï¼ˆå¹³å‡æ¯100æ¬¡è¯·æ±‚æ›´æ–°ä¸€æ¬¡ï¼‰
- **ç´¢å¼•æ¸…ç†**ï¼š0.5% æ¦‚ç‡ï¼ˆå¹³å‡æ¯200æ¬¡è¯·æ±‚æ¸…ç†ä¸€æ¬¡ï¼‰

### æ‰¹é‡æ“ä½œä¼˜åŒ–
- å•æ¬¡å†™å…¥æ•´è¡Œæ•°æ®ï¼ˆ`appendRow`ï¼‰
- é¿å…é¢‘ç¹è¯»å–ï¼ˆç¼“å­˜ç´¢å¼•æ•°æ®ï¼‰
- å¼‚æ­¥IPè·å–ï¼ˆä¸é˜»å¡ä¸»æµç¨‹ï¼‰

---

## ğŸ¯ å…³é”®æŠ€æœ¯ç»†èŠ‚

### 1. å¹¿å‘Šç‚¹å‡»æ£€æµ‹åŸç†
**æ ¸å¿ƒå‡è®¾**ï¼šç”¨æˆ·ç‚¹å‡»å¹¿å‘Šåä¼šç¦»å¼€é¡µé¢ï¼ŒçŸ­æ—¶é—´å†…è¿”å›è¯´æ˜æ˜¯è¯¯ç‚¹æˆ–å¿«é€Ÿè¿”å›

**æ£€æµ‹æ­¥éª¤**ï¼š
1. ç›‘å¬ `visibilitychange` äº‹ä»¶
2. é¡µé¢éšè—æ—¶è®°å½•æ—¶é—´æˆ³
3. é¡µé¢æ˜¾ç¤ºæ—¶è®¡ç®—ç¦»å¼€æ—¶é•¿
4. ç¦»å¼€æ—¶é•¿ â‰¤ 50ç§’ â†’ åˆ¤å®šä¸ºå¹¿å‘Šç‚¹å‡»

**ä¼˜åŠ¿**ï¼š
- âœ… æ— éœ€è®¿é—®å¹¿å‘Šiframeå†…éƒ¨
- âœ… ä¸ä¾èµ–å¹¿å‘Šå¹³å°API
- âœ… ç®€å•å¯é 

**å±€é™æ€§**ï¼š
- âš ï¸ å¯èƒ½è¯¯åˆ¤ï¼ˆç”¨æˆ·å¿«é€Ÿåˆ‡æ¢æ ‡ç­¾é¡µï¼‰
- âš ï¸ æ— æ³•æ£€æµ‹æ–°çª—å£æ‰“å¼€çš„å¹¿å‘Šç‚¹å‡»

### 2. è¡¨æ ¼å‘½åè§„èŒƒ
- **æ ¼å¼**ï¼š`xixi-YYYY-MM-DD`
- **ç¤ºä¾‹**ï¼š`xixi-2025-01-15`
- **ä¼˜åŠ¿**ï¼š
  - æ—¶é—´æ’åºå‹å¥½
  - æ˜“äºè¯†åˆ«å’Œç®¡ç†
  - æ”¯æŒæ—¥æœŸèŒƒå›´æŸ¥è¯¢

### 3. æ•°æ®éš”ç¦»ç­–ç•¥
- **æ¯æ—¥ç‹¬ç«‹è¡¨æ ¼**ï¼šé¿å…å•è¡¨æ•°æ®è¿‡å¤šå¯¼è‡´æ€§èƒ½é—®é¢˜
- **ä¸»è¡¨æ ¼ç´¢å¼•**ï¼šå¿«é€Ÿå®šä½ç›®æ ‡è¡¨æ ¼
- **åˆ†ç±»å·¥ä½œè¡¨**ï¼šä¸åŒç±»å‹æ•°æ®ç‹¬ç«‹å­˜å‚¨

### 4. é”™è¯¯å®¹é”™æœºåˆ¶
- **IPè·å–å¤±è´¥**ï¼šæ ‡è®°ä¸º `Unknown`ï¼Œä¸é˜»æ­¢æ•°æ®ä¸ŠæŠ¥
- **è¡¨æ ¼ä¸å­˜åœ¨**ï¼šè‡ªåŠ¨åˆ›å»ºå·¥ä½œè¡¨
- **ç´¢å¼•æŸå**ï¼šé€šè¿‡æ–‡ä»¶å¤¹æœç´¢æ¢å¤
- **å¹¶å‘å†²çª**ï¼šé”æœºåˆ¶ä¿æŠ¤

---

## ğŸ§ª æµ‹è¯•å‡½æ•°

### åç«¯æµ‹è¯•å‡½æ•°
```javascript
// æµ‹è¯•é¡µé¢è®¿é—®
function testPageVisit() {
    const testData = {
        eventType: 'page_visit',
        page: 'https://novel.goodluckark.com/novels/test/chapter-1',
        userAgent: 'Mozilla/5.0 (iPhone; Test)',
        referrer: 'https://novel.goodluckark.com/novels/test/index',
        userIP: '127.0.0.1'
    };
    
    const dateString = getDateString();
    const dailySpreadsheet = getOrCreateDailySpreadsheet(dateString);
    handlePageVisitEvent(dailySpreadsheet, testData);
    
    return 'æµ‹è¯•æ•°æ®å·²å†™å…¥: ' + dailySpreadsheet.getUrl();
}

// æµ‹è¯•å¹¿å‘Šå¼•å¯¼
function testAdGuide() { /* ... */ }

// æµ‹è¯•å¹¿å‘Šç‚¹å‡»
function testAdClick() { /* ... */ }

// æ‰‹åŠ¨æ›´æ–°æ§åˆ¶å°
function manualUpdateDashboard() { /* ... */ }

// æ‰‹åŠ¨æ¸…ç†é‡å¤ç´¢å¼•
function manualCleanupDuplicates() { /* ... */ }
```

---

## ğŸ“ˆ æ•°æ®æµé‡ä¼°ç®—

### å•æ¬¡è¯·æ±‚æ•°æ®é‡
- **é¡µé¢è®¿é—®**ï¼š~200 bytes
- **å¹¿å‘Šå¼•å¯¼**ï¼š~400 bytes
- **å¹¿å‘Šç‚¹å‡»**ï¼š~600 bytes

### æ—¥å‡é¢„ä¼°ï¼ˆå‡è®¾1000æ¬¡è®¿é—®ï¼‰
- **é¡µé¢è®¿é—®**ï¼š1000æ¬¡ â†’ 200KB
- **å¹¿å‘Šå¼•å¯¼**ï¼š50æ¬¡ï¼ˆ5%è½¬åŒ–ï¼‰ â†’ 20KB
- **å¹¿å‘Šç‚¹å‡»**ï¼š10æ¬¡ï¼ˆ1%è½¬åŒ–ï¼‰ â†’ 6KB
- **æ€»è®¡**ï¼š~226KB/å¤©

### Google Sheets é™åˆ¶
- **å•ä¸ªè¡¨æ ¼**ï¼šæœ€å¤š 500ä¸‡ä¸ªå•å…ƒæ ¼
- **å•æ¬¡å†™å…¥**ï¼šæœ€å¤š 10000è¡Œ
- **APIé…é¢**ï¼šæ¯å¤© 2000ä¸‡æ¬¡è¯»å†™æ“ä½œ
- **å½“å‰è®¾è®¡**ï¼šâœ… è¿œä½äºé™åˆ¶

---

## ğŸš€ éƒ¨ç½²ä¿¡æ¯

### APIç«¯ç‚¹
```
URL: https://script.google.com/macros/s/AKfycbw3OUxtOjrFe9MR2DfqjiPXj8kNYePnFItbYy_hZZYt8UEv5iz6m_7IbeR_V3gpMct3Kw/exec
æ–¹æ³•: POST
æ¨¡å¼: no-cors
å†…å®¹ç±»å‹: application/json
```

### ä¸»è¡¨æ ¼
```
ID: 1vbBuPqQE8ho6XJgZR4fxDskEfEbQn1CnD4I_K41FNyU
åç§°: ç½‘ç«™è®¿é—®ç»Ÿè®¡ç³»ç»Ÿï¼ˆä¸»æ§åˆ¶å°ï¼‰- xixié¡¹ç›®
URL: https://docs.google.com/spreadsheets/d/1vbBuPqQE8ho6XJgZR4fxDskEfEbQn1CnD4I_K41FNyU/
ä½ç½®: Google Drive / ç½‘ç«™ç»Ÿè®¡æ•°æ® æ–‡ä»¶å¤¹
```

### æ•°æ®å­˜å‚¨
```
ä½ç½®: Google Drive / ç½‘ç«™ç»Ÿè®¡æ•°æ® æ–‡ä»¶å¤¹
å‘½åè§„åˆ™: xixi-YYYY-MM-DD
ä¿ç•™ç­–ç•¥: æ— è‡ªåŠ¨æ¸…ç†ï¼ˆéœ€æ‰‹åŠ¨ç®¡ç†ï¼‰
```

---

## ğŸ“ æ€»ç»“

### âœ… ç³»ç»Ÿä¼˜åŠ¿
1. **å…¨è‡ªåŠ¨åŒ–**ï¼šæ— éœ€æ‰‹åŠ¨å¹²é¢„ï¼Œè‡ªåŠ¨åˆ›å»ºè¡¨æ ¼å’Œåˆ†ç±»
2. **é«˜å¹¶å‘æ”¯æŒ**ï¼šé”æœºåˆ¶ä¿æŠ¤ï¼Œé˜²æ­¢æ•°æ®å†²çª
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ¦‚ç‡æ€§æ›´æ–°ï¼Œå‡å°‘ä¸å¿…è¦çš„å†™å…¥
4. **å®¹é”™æ€§å¼º**ï¼šå¤šå±‚å¤‡ç”¨æœºåˆ¶ï¼Œç¡®ä¿æ•°æ®ä¸ä¸¢å¤±
5. **æ˜“äºç»´æŠ¤**ï¼šæ¯æ—¥ç‹¬ç«‹è¡¨æ ¼ï¼Œä¾¿äºæŸ¥è¯¢å’Œç®¡ç†

### âš ï¸ æ³¨æ„äº‹é¡¹
1. **ç´¢å¼•å¯èƒ½é‡å¤**ï¼š0.5%æ¦‚ç‡è‡ªåŠ¨æ¸…ç†ï¼Œä¹Ÿå¯æ‰‹åŠ¨æ¸…ç†
2. **IPè·å–å»¶è¿Ÿ**ï¼šå¯èƒ½å½±å“ä¸ŠæŠ¥é€Ÿåº¦ï¼Œä½†ä¸é˜»å¡æµç¨‹
3. **å¹¿å‘Šç‚¹å‡»è¯¯åˆ¤**ï¼š50ç§’çª—å£å¯èƒ½å­˜åœ¨è¯¯åˆ¤
4. **å­˜å‚¨ç©ºé—´ç®¡ç†**ï¼šéœ€å®šæœŸæ¸…ç†å†å²è¡¨æ ¼

### ğŸ”® ä¼˜åŒ–æ–¹å‘
1. å®ç°è‡ªåŠ¨å½’æ¡£ï¼ˆä¾‹å¦‚ï¼š30å¤©åç§»åŠ¨åˆ°å½’æ¡£æ–‡ä»¶å¤¹ï¼‰
2. æ·»åŠ å¼‚å¸¸ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
3. ä¼˜åŒ–IPè·å–é€Ÿåº¦ï¼ˆä½¿ç”¨CDNåŠ é€Ÿçš„APIï¼‰
4. å¢åŠ æ•°æ®å¯è§†åŒ–Dashboard

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æ›´æ–°æ—¥æœŸ**ï¼š2025-01-15  
**ç»´æŠ¤è€…**ï¼šç³»ç»Ÿç®¡ç†å‘˜
